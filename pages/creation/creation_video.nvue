<template>
  <view class="page">
    <!-- è§†é¢‘æœ¬ä½“ -->
    <video
      id="creationVideo"
      class="video"
      :src="creation.videoUrl"
      :poster="creation.coverImage"
      :autoplay="true"
      :loop="true"
      :controls="false"
      object-fit="contain"
      @click="handleVideoTap"
    ></video>

    <!-- é¡¶éƒ¨ï¼šåªæœ‰è¿”å› -->
    <view class="top-bar">
      <view class="back-btn" @click="goBack">
        <text class="back-icon">â†</text>
      </view>
    </view>

    <!-- å³ä¾§å¤´åƒ + ç‚¹èµ / è¯„è®º / è½¬å‘ -->
    <view class="right-actions">
      <!-- å¤´åƒ + å…³æ³¨ï¼ˆä½œè€…æœ¬äººä¸æ˜¾ç¤ºå…³æ³¨ï¼‰ -->
      <view
        class="action-item avatar-item"
        @click="goToUserPage(creation.author.user_id)"
      >
        <view class="avatar-touch">
          <view class="avatar-wrapper">
            <image
              class="avatar-img"
              :src="creation.author.avatar || defaultAvatar"
            />
          </view>
        </view>
        <view
          v-if="!isSelfAuthor && !isFollowed"
          class="follow-plus"
          @click.stop="handleFollowClick"
        >
          <text class="follow-plus-text">+</text>
        </view>
      </view>

      <!-- ç‚¹èµ -->
      <view class="action-item" @click="toggleLike">
        <view class="action-hit">
          <text class="action-icon" :class="{ liked: isLiked }">
            {{ isLiked ? 'â™¥ï¸' : 'â™¡' }}
          </text>
          <text class="action-count">
            {{ formatNumber(creation.likes) }}
          </text>
        </view>
      </view>

      <!-- è¯„è®ºï¼šç‚¹å‡»åå†åŠ è½½è¯„è®ºåˆ—è¡¨ / å›å¤åˆ—è¡¨ -->
      <view class="action-item" @click="openCommentsPanel">
        <view class="action-hit">
          <text class="action-icon">ğŸ’¬</text>
          <text class="action-count">
            {{ formatNumber(creation.comments) }}
          </text>
        </view>
      </view>

      <!-- è½¬å‘ -->
      <view class="action-item" @click="handleShare">
        <view class="action-hit">
          <text class="action-icon">â†—</text>
          <text class="action-count">
            {{ formatNumber(creation.shares) }}
          </text>
        </view>
      </view>
    </view>

    <!-- ä¸­é—´æš‚åœ / æ’­æ”¾ å›¾æ ‡ -->
    <view v-if="showCenterIcon && !showCommentsPanel" class="center-icon">
      <view class="center-icon-inner">
        <text class="center-icon-text">
          {{ isPlaying ? 'â¸' : 'â–¶ï¸' }}
        </text>
      </view>
    </view>

    <!-- åº•éƒ¨ä¿¡æ¯ -->
    <view class="bottom-info">
      <view class="author-row" @click="goToUserPage(creation.author.user_id)">
        <text class="author-name">
          @{{ creation.author.username || 'åŒ¿åç”¨æˆ·' }}
        </text>
      </view>

      <view class="title-row">
        <text class="title-text">
          {{ creation.title || 'æ— æ ‡é¢˜ä½œå“' }}
        </text>
      </view>

      <view class="detail-row">
        <text
          class="detail-text"
          :lines="isDetailExpanded ? 10 : 2"
        >
          {{ creation.detail }}
        </text>
        <text
          v-if="creation.detail && creation.detail.length > 50"
          class="detail-expand"
          @click="toggleDetail"
        >
          {{ isDetailExpanded ? 'æ”¶èµ·' : '...å±•å¼€' }}
        </text>
      </view>

      <!-- category ç°è‰²åœ†è§’çŸ©å½¢ -->
      <view class="category-row" v-if="categoryLabel">
        <text class="category-text"># {{ categoryLabel }}</text>
      </view>

      <view class="tags-row" v-if="creation.tags && creation.tags.length">
        <text
          class="tag-text"
          v-for="(tag, index) in creation.tags"
          :key="index"
        >
          # {{ tag }}
        </text>
      </view>
    </view>

    <!-- è¯„è®ºæŠ½å±‰ -->
    <view
      v-if="showCommentsPanel"
      class="comments-mask"
      @click="closeCommentsPanelByMask"
    >
      <view class="comments-panel" @click.stop>
        <view class="comments-header">
          <text class="comments-title">
            è¯„è®º {{ formatNumber(creation.comments) }}
          </text>

          <view class="comments-header-right">
            <view class="comments-sort" @click="toggleCommentSort">
              <text class="comments-sort-label">
                {{ commentSortType === 'time' ? 'æŒ‰æ—¶é—´' : 'æŒ‰çƒ­åº¦' }}
              </text>
            </view>
            <text class="comments-close" @click="closeCommentsPanel">âœ•</text>
          </view>
        </view>

        <!-- è¯„è®ºåˆ—è¡¨ï¼šè§¦åº•åˆ†é¡µ -->
        <scroll-view
          scroll-y="true"
          class="comments-scroll"
          @scrolltolower="onCommentsScrollToLower"
          lower-threshold="80"
        >
          <!-- ä¸€çº§è¯„è®º -->
          <view
            class="comment-item"
            v-for="comment in commentList"
            :key="comment.id"
          >
            <image
              class="comment-avatar"
              :src="comment.user.avatar || defaultAvatar"
              @click="goToUserPage(comment.user.user_id)"
            />
            <view class="comment-main">
              <view class="comment-header">
                <text
                  class="comment-username"
                  @click="goToUserPage(comment.user.user_id)"
                >
                  {{ comment.user.name }}
                </text>
                <view
                  class="comment-like"
                  :class="{ liked: comment.isLiked }"
                  @click="toggleCommentLike(comment)"
                >
                  <text class="comment-like-icon">
                    {{ comment.isLiked ? 'â™¥ï¸' : 'â™¡' }}
                  </text>
                  <text
                    v-if="comment.likes > 0"
                    class="comment-like-count"
                  >
                    {{ formatNumber(comment.likes) }}
                  </text>
                </view>
              </view>

              <view class="comment-text-wrap">
                <text class="comment-text">
                  {{ comment.text }}
                </text>
              </view>

              <view class="comment-meta">
                <text class="comment-time">
                  {{ formatRelativeTime(comment.time) }}
                </text>
                <text
                  class="comment-reply"
                  @click="replyToComment(comment, comment)"
                >
                  å›å¤
                </text>
              </view>

              <!-- ä¸€çº§è¯„è®ºä¸‹æ–¹ï¼šå±•å¼€ X æ¡å›å¤ -->
              <view
                v-if="comment.replyCount && !comment.showReplies"
                class="comment-replies-toggle"
                @click="toggleReplies(comment)"
              >
                <text class="comment-replies-toggle-text">
                  å±•å¼€{{ comment.replyCount }}æ¡å›å¤
                </text>
              </view>

              <!-- äºŒçº§å›å¤åˆ—è¡¨ -->
              <view v-if="comment.showReplies" class="reply-list">
                <view
                  class="reply-item"
                  v-for="reply in comment.replies"
                  :key="reply.id"
                >
                  <image
                    class="reply-avatar"
                    :src="reply.user.avatar || defaultAvatar"
                    @click="goToUserPage(reply.user.user_id)"
                  />
                  <view class="reply-main">
                    <view class="reply-header">
                      <view class="reply-name-line">
                        <text
                          class="reply-username"
                          @click="goToUserPage(reply.user.user_id)"
                        >
                          {{ reply.user.name }}
                        </text>
                        <!-- ä»…å¯¹äºŒçº§è¯„è®ºçš„å›å¤å±•ç¤º @sib_username -->
                        <text
                          v-if="reply.replyToUser && reply.replyToUserId"
                          class="reply-at"
                          @click.stop="goToUserPage(reply.replyToUserId)"
                        >
                          å›å¤ @{{ reply.replyToUser }}
                        </text>
                      </view>

                      <view
                        class="reply-like"
                        :class="{ liked: reply.isLiked }"
                        @click="toggleCommentLike(reply)"
                      >
                        <text class="reply-like-icon">
                          {{ reply.isLiked ? 'â™¥ï¸' : 'â™¡' }}
                        </text>
                        <text
                          v-if="reply.likes > 0"
                          class="reply-like-count"
                        >
                          {{ formatNumber(reply.likes) }}
                        </text>
                      </view>
                    </view>

                    <text class="reply-text">
                      {{ reply.text }}
                    </text>

                    <view class="reply-meta">
                      <text class="reply-time">
                        {{ formatRelativeTime(reply.time) }}
                      </text>
                      <text
                        class="reply-reply"
                        @click="replyToComment(reply, comment)"
                      >
                        å›å¤
                      </text>
                    </view>
                  </view>
                </view>

                <!-- å±•å¼€æ›´å¤š / æ”¶èµ· åœ¨åŒä¸€è¡Œï¼Œæ•´ä½“ä¸ä¸€çº§è¯„è®ºç”¨æˆ·åå·¦ä¾§å¯¹é½ -->
                <view class="reply-footer">
                  <text
                    v-if="comment.replyHasMore && !comment.replyLoading"
                    @click="loadMoreReplies(comment)"
                  >
                    å±•å¼€æ›´å¤šå›å¤
                  </text>
                  <text
                    v-if="comment.replyLoading"
                    class="reply-footer-loading"
                  >
                    å›å¤åŠ è½½ä¸­...
                  </text>
                  <text
                    class="reply-footer-collapse"
                    @click="toggleReplies(comment)"
                  >
                    æ”¶èµ·
                  </text>
                </view>
              </view>
            </view>
          </view>

          <view
            v-if="!commentList.length && !commentLoading"
            class="empty-comments"
          >
            <text class="empty-comments-text">è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</text>
          </view>

          <view
            v-if="commentLoading && commentList.length"
            class="empty-comments"
          >
            <text class="empty-comments-text">è¯„è®ºåŠ è½½ä¸­...</text>
          </view>
        </scroll-view>

        <!-- åº•éƒ¨è¾“å…¥ -->
        <view class="comment-input-bar">
          <input
            class="comment-input"
            v-model="commentText"
            :placeholder="commentPlaceholder"
            :focus="commentInputFocus"
            confirm-type="send"
            @blur="handleInputBlurInPanel"
            @confirm="sendComment"
          />
          <view
            class="send-btn"
            :class="{ active: commentText.trim() }"
            @click="sendComment"
          >
            <text
              :class="[
                'send-btn-text',
                commentText.trim() ? 'send-btn-text-active' : ''
              ]"
            >
              å‘é€
            </text>
          </view>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
import { getCreationById } from '@/request/creation.js'
import { getUserProfile } from '@/request/user.js'
import {
  digg,
  cancelDigg,
  createComment,
  createReply,
  getCommentList,
  getCommentCount,
  diggComment,
  cancelDiggComment,
  getReplyList,
  follow,
  unfollow
} from '@/request/action.js'

export default {
  data() {
    return {
      creationId: '',
      authorId: '',
      videoContext: null,

      defaultAvatar: '/static/user_avatar.png',

      creation: {
        creationId: '',
        userId: '',
        type: 'video',
        title: '',
        detail: '',
        videoUrl: '',
        coverImage: '',
        tags: [],
        time: '',
        location: '',
        category: '',
        author: {
          user_id: '',
          username: '',
          avatar: '',
          followerCount: 0
        },
        likes: 0,
        comments: 0,
        shares: 0
      },

      currentUserId: null,
      username: '',
      avatar: '',

      isLiked: false,
      isFollowed: false,
      isDetailExpanded: false,

      isPlaying: true,
      showCenterIcon: false,
      centerIconTimer: null,

      // è¯„è®ºæŠ½å±‰
      showCommentsPanel: false,

      // è¯„è®ºæ•°æ®
      commentList: [],
      commentLoading: false,
      commentPage: 1,
      commentHasMore: true,
      commentSortType: 'digg',
      commentsInitialized: false,

      // è¾“å…¥çŠ¶æ€
      commentText: '',
      commentPlaceholder: 'è¯´ç‚¹ä»€ä¹ˆ...',
      commentInputFocus: false,
      replyingTo: null,

      likeLoading: false
    }
  },

  computed: {
    // category -> ä¸­æ–‡æ ‡ç­¾
    categoryLabel() {
      const map = {
        life: 'ç”Ÿæ´»',
        society: 'ç¤¾ä¼š',
        tech: 'ç§‘æŠ€',
        entertainment: 'å¨±ä¹'
      }
      return map[this.creation.category] || ''
    },
    // æ˜¯å¦ä½œè€…æœ¬äºº
    isSelfAuthor() {
      if (!this.currentUserId || !this.creation.author.user_id) return false
      return String(this.currentUserId) === String(this.creation.author.user_id)
    }
  },

  onLoad(options) {
    this.creationId = options.creationId
    this.authorId = options.userId

    const app = getApp()
    if (app && app.globalData) {
      this.currentUserId = app.globalData.userId || null
      this.username = app.globalData.username || app.globalData.nickname || ''
      this.avatar = app.globalData.avatar || this.defaultAvatar
    }

    this.initPage()
  },

  onReady() {
    this.videoContext = uni.createVideoContext('creationVideo', this)
  },

  onUnload() {
    if (this.centerIconTimer) {
      clearTimeout(this.centerIconTimer)
      this.centerIconTimer = null
    }
  },

  methods: {
    async initPage() {
      uni.showLoading({ title: 'åŠ è½½ä¸­...' })
      const ok1 = await this.fetchCreationDetail()
      const ok2 = await this.fetchAuthorInfo()
      // è¿›å…¥è§†é¢‘é¡µé¢æ—¶å°±åŠ è½½è¯„è®ºæ•°é‡
      const ok3 = await this.fetchCommentCount()
      if (!ok1 || !ok2 || !ok3) {
        uni.showToast({ title: 'åŠ è½½å¤±è´¥', icon: 'none' })
      }
      uni.hideLoading()
    },

    async fetchCreationDetail() {
      const res = await getCreationById(this.creationId)
      if (!res || !res.creation) return false

      const c = res.creation
      const materialType = c.material_type
      const isVideo = Number(materialType) === 2

      this.creation.creationId = c.creation_id || this.creationId
      this.creation.userId = c.user_id || this.authorId
      this.creation.type = isVideo ? 'video' : 'image'
      this.creation.title = c.title || ''
      this.creation.detail = c.content || ''
      this.creation.category = c.category || ''
      this.creation.time = c.create_time || ''

      const cover = c.cover_url || c.material_url || ''
      this.creation.coverImage = cover
      this.creation.videoUrl = isVideo ? (c.material_url || '') : ''

      this.creation.likes = c.digg_count || 0
      this.creation.comments = c.comment_count || 0
      this.creation.shares = c.share_count || 0
      this.isLiked = !!c.is_digg

      return true
    },

    async fetchAuthorInfo() {
      const targetUserId = this.authorId || this.creation.userId
      if (!targetUserId) return false

      const res = await getUserProfile(targetUserId, true, false)
      if (!res || !res.user_info) return false

      const info = res.user_info || {}
      this.creation.author = {
        user_id: info.user_id || targetUserId,
        username: info.username || info.nickname || '',
        avatar: info.avatar || this.defaultAvatar,
        followerCount: res.follower_count || 0
      }
      this.isFollowed = !!res.is_following
      return true
    },

    async fetchCommentCount() {
      if (!this.creationId) return false
      const payload = {
        entityType: 'creation',
        entityId: BigInt(this.creationId)
      }
      const res = await getCommentCount(payload)
      if (!res || typeof res.comment_count !== 'number') return false
      this.creation.comments = res.comment_count
      return true
    },

    goBack() {
      uni.navigateBack()
    },

    handleVideoTap() {
      if (!this.videoContext) return

      if (this.isPlaying) {
        this.videoContext.pause()
        this.isPlaying = false
        if (this.centerIconTimer) {
          clearTimeout(this.centerIconTimer)
          this.centerIconTimer = null
        }
        this.showCenterIcon = true
      } else {
        this.videoContext.play()
        this.isPlaying = true
        this.showCenterIcon = true
        if (this.centerIconTimer) clearTimeout(this.centerIconTimer)
        this.centerIconTimer = setTimeout(() => {
          this.showCenterIcon = false
          this.centerIconTimer = null
        }, 600)
      }
    },

    async toggleLike() {
      if (this.likeLoading || !this.creation.creationId) return
      this.likeLoading = true

      let ok = false
      if (this.isLiked) {
        ok = await cancelDigg('creation', this.creation.creationId)
        if (ok) {
          this.isLiked = false
          this.creation.likes = Math.max(0, this.creation.likes - 1)
        }
      } else {
        ok = await digg('creation', this.creation.creationId)
        if (ok) {
          this.isLiked = true
          this.creation.likes += 1
        }
      }

      if (!ok) {
        uni.showToast({ title: 'æ“ä½œå¤±è´¥', icon: 'none' })
      }
      this.likeLoading = false
    },

    async handleFollowClick() {
      const currentUserId = this.currentUserId
      const targetUserId = this.creation.author.user_id
      if (!currentUserId || !targetUserId) return

      const ok = await follow(currentUserId, targetUserId)
      if (!ok) {
        uni.showToast({ title: 'æ“ä½œå¤±è´¥', icon: 'none' })
        return
      }
      this.isFollowed = true
      this.creation.author.followerCount += 1
      uni.showToast({ title: 'å…³æ³¨æˆåŠŸ', icon: 'none' })
    },

    toggleDetail() {
      this.isDetailExpanded = !this.isDetailExpanded
    },

    async openCommentsPanel() {
      this.showCommentsPanel = true
      this.commentInputFocus = false

      // è¯„è®ºæ•°é‡å·²åœ¨è¿›å…¥é¡µé¢æ—¶åŠ è½½ï¼›è¿™é‡Œåªåšè¯„è®ºåˆ—è¡¨åˆå§‹åŒ–
      if (!this.commentsInitialized) {
        const ok2 = await this.fetchComments(true)
        this.commentsInitialized = true
        if (!ok2) {
          uni.showToast({ title: 'è¯„è®ºåŠ è½½å¤±è´¥', icon: 'none' })
        }
      }
    },

    closeCommentsPanel() {
      this.showCommentsPanel = false
      this.commentText = ''
      this.replyingTo = null
      this.commentPlaceholder = 'è¯´ç‚¹ä»€ä¹ˆ...'
      this.commentInputFocus = false
    },

    closeCommentsPanelByMask() {
      this.closeCommentsPanel()
    },

    async fetchComments(reset = false) {
      if (this.commentLoading) return false
      if (!reset && !this.commentHasMore) return false
      if (!this.creationId) return false

      this.commentLoading = true
      const pageToLoad = reset ? 1 : this.commentPage + 1

      const payload = {
        entityType: 'creation',
        entityId: BigInt(this.creationId),
        page: pageToLoad,
        sortType: this.commentSortType
      }

      const res = await getCommentList(payload)
      if (!res) {
        this.commentLoading = false
        return false
      }

      const list = res.comments || []
      const mapped = list.map((c) => ({
        id: c.comment_id,
        user: {
          user_id: c.user_id,
          name: c.username,
          avatar: c.avatar
        },
        text: c.content,
        time: c.create_time,
        likes: c.digg_count || 0,
        isLiked: !!c.is_digg,
        replyToUser: c.sib_username || '',
        replyToUserId: c.sib_user_id || null,
        replyCount: c.reply_count || 0,

        showReplies: false,
        replies: [],
        replyPage: 0,
        replyHasMore: (c.reply_count || 0) > 0,
        replyLoading: false,
        _loading: false
      }))

      if (reset) {
        this.commentList = mapped
        this.commentPage = 1
      } else {
        this.commentList = this.commentList.concat(mapped)
        this.commentPage = pageToLoad
      }

      const pageSize = 10
      this.commentHasMore = list.length >= pageSize
      this.commentLoading = false
      return true
    },

    onCommentsScrollToLower() {
      this.fetchComments(false)
    },

    toggleCommentSort() {
      this.commentSortType = this.commentSortType === 'time' ? 'digg' : 'time'
      this.commentPage = 1
      this.commentHasMore = true
      this.fetchComments(true)
    },

    async toggleReplies(comment) {
      if (!comment) return
      if (!comment.showReplies) {
        comment.showReplies = true
        if (!comment.replies.length && comment.replyCount) {
          await this.loadReplies(comment, true)
        }
      } else {
        comment.showReplies = false
      }
    },

    async loadReplies(comment, reset = false) {
      if (!comment) return
      if (comment.replyLoading) return
      if (!reset && !comment.replyHasMore) return
      if (!this.creationId) return

      comment.replyLoading = true
      const pageToLoad = reset ? 1 : (comment.replyPage || 0) + 1

      const payload = {
        entityType: 'creation',
        entityId: BigInt(this.creationId),
        commentId: BigInt(comment.id),
        page: pageToLoad
      }

      const res = await getReplyList(payload)
      if (!res) {
        comment.replyLoading = false
        return
      }

      const list = res.replies || res.comments || []
      const mapped = list.map((r) => ({
        id: r.comment_id,
        user: {
          user_id: r.user_id,
          name: r.username,
          avatar: r.avatar
        },
        text: r.content,
        time: r.create_time,
        likes: r.digg_count || 0,
        isLiked: !!r.is_digg,
        replyToUser: r.sib_username || '',
        replyToUserId: r.sib_user_id || null,
        replyCount: 0,
        showReplies: false,
        replies: [],
        replyPage: 0,
        replyHasMore: false,
        replyLoading: false,
        _loading: false
      }))

      if (reset || !comment.replies.length) {
        comment.replies = mapped
        comment.replyPage = 1
      } else {
        comment.replies = comment.replies.concat(mapped)
        comment.replyPage = pageToLoad
      }

      const pageSize = 10
      comment.replyHasMore = list.length >= pageSize
      comment.replyLoading = false
    },

    loadMoreReplies(comment) {
      this.loadReplies(comment, false)
    },

    goToUserPage(userId) {
      const targetId = userId || this.creation.author.user_id
      if (!targetId) return
      uni.navigateTo({
        url: `/pages/user/user_profile?userId=${targetId}`
      })
    },

    async toggleCommentLike(comment) {
      if (!comment || comment._loading) return

      comment._loading = true
      const payload = {
        commentId: BigInt(comment.id)
      }

      let ok = false
      if (comment.isLiked) {
        ok = await cancelDiggComment(payload)
        if (ok) {
          comment.isLiked = false
          comment.likes = Math.max(0, comment.likes - 1)
        }
      } else {
        ok = await diggComment(payload)
        if (ok) {
          comment.isLiked = true
          comment.likes += 1
        }
      }

      if (!ok) {
        uni.showToast({ title: 'æ“ä½œå¤±è´¥', icon: 'none' })
      }
      comment._loading = false
    },

    // parentComment æ˜¯ä¸€çº§è¯„è®ºï¼ŒtargetComment å¯èƒ½æ˜¯ä¸€çº§æˆ–äºŒçº§
    replyToComment(targetComment, parentComment) {
      if (!targetComment) return
      const parent = parentComment || targetComment

      const isReplyToReply = parent.id !== targetComment.id

      this.replyingTo = {
        parentId: parent.id,
        displayName: targetComment.user.name || '',
        isReplyToReply,
        // å¯¹ä¸€çº§è¯„è®ºçš„å›å¤ï¼šsibId / sibUserId ä¸º 0
        sibId: isReplyToReply ? targetComment.id : 0,
        sibUserId: isReplyToReply ? (targetComment.user.user_id || 0) : 0
      }

      this.commentPlaceholder = this.replyingTo.displayName
        ? `å›å¤ @${this.replyingTo.displayName}`
        : 'å›å¤'
      this.commentInputFocus = true
    },

    handleInputBlurInPanel() {
      setTimeout(() => {
        this.commentInputFocus = false
      }, 200)
    },

    async sendComment() {
      const text = this.commentText.trim()
      if (!text) return

      const currentUserId = this.currentUserId
      const currentUserName = this.username || ''
      const currentAvatar = this.avatar || this.defaultAvatar

      let res

      if (this.replyingTo) {
        // å›å¤
        const payload = {
          parentId: BigInt(this.replyingTo.parentId),
          entityType: 'creation',
          entityId: BigInt(this.creationId),
          contentType: 1,
          content: text,
          sibId: BigInt(this.replyingTo.sibId || 0),
          sibUserId: BigInt(this.replyingTo.sibUserId || 0)
        }
        res = await createReply(payload)
      } else {
        // ä¸€çº§è¯„è®º
        const payload = {
          entityType: 'creation',
          entityId: BigInt(this.creationId),
          contentType: 1,
          content: text
        }
        res = await createComment(payload)
      }

      if (!res || !res.comment_id) {
        uni.showToast({ title: 'å‘é€å¤±è´¥', icon: 'none' })
        return
      }

      const newId = res.comment_id

      if (this.replyingTo) {
        const parentIndex = this.commentList.findIndex(
          (c) => String(c.id) === String(this.replyingTo.parentId)
        )
        if (parentIndex !== -1) {
          const parent = this.commentList[parentIndex]
          const isReplyToReply = !!this.replyingTo.isReplyToReply

          const replyComment = {
            id: newId,
            user: {
              user_id: currentUserId,
              name: currentUserName,
              avatar: currentAvatar
            },
            text,
            time: Date.now(),
            likes: 0,
            isLiked: false,
            replyToUser: isReplyToReply ? (this.replyingTo.displayName || '') : '',
            replyToUserId: isReplyToReply ? (this.replyingTo.sibUserId || null) : null,
            replyCount: 0,
            showReplies: false,
            replies: [],
            replyPage: 0,
            replyHasMore: false,
            replyLoading: false,
            _loading: false
          }

          if (!Array.isArray(parent.replies)) {
            parent.replies = []
          }
          parent.replies.push(replyComment)
          parent.replyCount += 1
          parent.showReplies = true
        }
      } else {
        const newComment = {
          id: newId,
          user: {
            user_id: currentUserId,
            name: currentUserName,
            avatar: currentAvatar
          },
          text,
          time: Date.now(),
          likes: 0,
          isLiked: false,
          replyToUser: '',
          replyToUserId: null,
          replyCount: 0,
          showReplies: false,
          replies: [],
          replyPage: 0,
          replyHasMore: false,
          replyLoading: false,
          _loading: false
        }
        this.commentList.unshift(newComment)
      }

      this.creation.comments += 1

      uni.showToast({ title: 'å‘é€æˆåŠŸ', icon: 'success' })
      this.commentText = ''
      this.commentPlaceholder = 'è¯´ç‚¹ä»€ä¹ˆ...'
      this.replyingTo = null
      this.commentInputFocus = false
    },

    handleShare() {
      uni.showToast({ title: 'åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­', icon: 'none' })
    },

    formatNumber(num) {
      if (!num) return 0
      const n = Number(num) || 0
      if (n >= 10000) return (n / 10000).toFixed(1) + 'w'
      if (n >= 1000) return (n / 1000).toFixed(1) + 'k'
      return n
    },

    formatRelativeTime(msTimestamp) {
      if (!msTimestamp) return ''
      if (msTimestamp < 1e12) {
        msTimestamp = msTimestamp * 1000
      }

      const now = new Date()
      const target = new Date(msTimestamp)
      const nowMs = now.getTime()
      const diffMs = nowMs - msTimestamp
      const diffSec = Math.floor(diffMs / 1000)

      if (diffSec < 60) {
        return 'åˆšåˆš'
      }
      if (diffSec < 3600) {
        const m = Math.floor(diffSec / 60)
        return `${m}åˆ†é’Ÿå‰`
      }

      const oneDayMs = 24 * 60 * 60 * 1000
      const todayStart = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate()
      ).getTime()

      const pad2 = (n) => (n < 10 ? '0' + n : '' + n)
      const hhmm = `${pad2(target.getHours())}:${pad2(target.getMinutes())}`

      if (msTimestamp >= todayStart) {
        return `ä»Šå¤© ${hhmm}`
      }
      if (msTimestamp >= todayStart - oneDayMs) {
        return `æ˜¨å¤© ${hhmm}`
      }

      const diffDay = Math.floor(diffMs / oneDayMs)
      if (diffDay < 7) {
        return `${diffDay}å¤©å‰`
      }

      const year = target.getFullYear()
      const month = target.getMonth() + 1
      const day = target.getDate()

      if (year !== now.getFullYear()) {
        return `${year}å¹´${month}æœˆ${day}æ—¥`
      }
      return `${month}æœˆ${day}æ—¥`
    }
  }
}
</script>

<style>
.page {
  flex: 1;
  background-color: #000000;
  position: relative;
}

/* è§†é¢‘ */
.video {
  width: 750rpx;
  flex: 1;
}

/* é¡¶éƒ¨è¿”å›å·¦ä¸Šè§’ */
.top-bar {
  position: absolute;
  top: 0;
  left: 0;
  width: 750rpx;
  height: 64px;
  padding-left: 20px;
  padding-top: 20px;
  flex-direction: row;
  justify-content: flex-start;
  align-items: center;
}

.back-btn {
  width: 40px;
  height: 40px;
  border-radius: 20px;
  background-color: rgba(0, 0, 0, 0.4);
  justify-content: center;
  align-items: center;
}

.back-icon {
  font-size: 22px;
  color: #ffffff;
}

/* å³ä¾§æ“ä½œæ ï¼šé ä¸‹åä¸­ */
.right-actions {
  position: absolute;
  right: 16px;
  top: 0;
  bottom: 0;
  justify-content: flex-end;
  align-items: center;
  padding-bottom: 50%;
}

.action-item {
  width: 68px;
  height: 68px;
  justify-content: center;
  align-items: center;
  margin-bottom: 18px;
}

.avatar-item {
  height: 90px;
  position: relative;
}

.avatar-touch {
  width: 68px;
  height: 68px;
  justify-content: center;
  align-items: center;
}

.avatar-wrapper {
  width: 52px;
  height: 52px;
  border-radius: 26px;
  border-width: 2px;
  border-style: solid;
  border-color: #ffffff;
  overflow: hidden;
  justify-content: center;
  align-items: center;
}

.avatar-img {
  width: 52px;
  height: 52px;
  border-radius: 26px;
}

/* å…³æ³¨ + åœ†å½¢ï¼Œå’Œå¤´åƒä¸­å¿ƒåœ¨åŒä¸€ç«–ç›´çº¿ */
.follow-plus {
  position: absolute;
  bottom: 6px;
  left: 23px;
  width: 22px;
  height: 22px;
  border-radius: 11px;
  background-color: #ff4757;
  border-width: 2px;
  border-style: solid;
  border-color: #ffffff;
  justify-content: center;
  align-items: center;
}

.follow-plus-text {
  font-size: 14px;
  color: #ffffff;
  font-weight: bold;
}

.action-hit {
  width: 68px;
  justify-content: center;
  align-items: center;
}

.action-icon {
  font-size: 30px;
  color: #ffffff;
  text-align: center;
}

.action-icon.liked {
  color: #ff4757;
}

.action-count {
  font-size: 12px;
  color: #ffffff;
  margin-top: 2px;
  text-align: center;
}

/* ä¸­é—´æš‚åœ / æ’­æ”¾å›¾æ ‡ */
.center-icon {
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  justify-content: center;
  align-items: center;
}

.center-icon-inner {
  width: 80px;
  height: 80px;
  border-radius: 40px;
  background-color: rgba(0, 0, 0, 0.4);
  justify-content: center;
  align-items: center;
}

.center-icon-text {
  font-size: 44px;
  color: #ffffff;
}

/* åº•éƒ¨ä¿¡æ¯ï¼šæ•´ä½“ç¨å¾®å‘å·¦ã€å‘ä¸‹ç´§è´´ä¸€ç‚¹ */
.bottom-info {
  position: absolute;
  left: 10px;
  right: 90px;
  bottom: 12px;
}

.author-row {
  margin-bottom: 10px;
}

.author-name {
  font-size: 18px;
  font-weight: 700;
  color: #ffffff;
}

.title-row {
  margin-bottom: 8px;
}

.title-text {
  font-size: 18px;
  color: #ffffff;
  line-height: 22px;
  margin-left: 6px;
}

.detail-row {
  margin-bottom: 6px;
}

.detail-text {
  font-size: 16px;
  color: #f5f5f5;
  line-height: 20px;
  margin-left: 6px;
}

.detail-expand {
  margin-top: 2px;
  font-size: 13px;
  color: rgba(255, 255, 255, 0.9);
}

/* category ç°è‰²åœ†è§’çŸ©å½¢ */
.category-row {
  margin-bottom: 6px;
}

.category-text {
  padding-left: 6px;
  padding-right: 10px;
  padding-top: 4px;
  padding-bottom: 4px;
  font-size: 14px;
  color: #f5f5f5;
  background-color: rgba(0, 0, 0, 0.4);
  border-radius: 999px;
}

.tags-row {
  margin-top: 4px;
  flex-direction: row;
  flex-wrap: wrap;
}

.tag-text {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.9);
  margin-right: 6px;
  margin-bottom: 2px;
}

/* è¯„è®ºé®ç½©å’ŒæŠ½å±‰ */
.comments-mask {
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  justify-content: flex-end;
  align-items: center;
}

.comments-panel {
  width: 750rpx;
  height: 900rpx; /* å¤§çº¦ 2/3 å±é«˜ */
  background-color: #ffffff;
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
}

/* è¯„è®ºå¤´éƒ¨ */
.comments-header {
  height: 48px;
  padding-left: 16px;
  padding-right: 16px;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  border-bottom-width: 1px;
  border-bottom-style: solid;
  border-bottom-color: #f0f0f0;
}

.comments-title {
  font-size: 16px;
  font-weight: 600;
  color: #333333;
}

.comments-header-right {
  flex-direction: row;
  align-items: center;
}

.comments-sort {
  padding: 4px 10px;
  border-radius: 12px;
  background: #f5f5f5;
  margin-right: 8px;
}

.comments-sort-label {
  font-size: 12px;
  color: #666666;
}

.comments-close {
  font-size: 20px;
  color: #999999;
}

/* è¯„è®ºåˆ—è¡¨æ»šåŠ¨ */
.comments-scroll {
  flex: 1;
  padding-left: 16px;
  padding-right: 16px;
}

/* å•æ¡è¯„è®º */
.comment-item {
  padding-top: 10px;
  padding-bottom: 10px;
  border-bottom-width: 1px;
  border-bottom-style: solid;
  border-bottom-color: #f5f5f5;
  flex-direction: row;
}

.comment-avatar {
  width: 36px;
  height: 36px;
  border-radius: 18px;
  margin-right: 10px;
}

.comment-main {
  flex: 1;
}

.comment-header {
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
}

.comment-username {
  font-size: 14px;
  font-weight: 500;
  color: #333333;
}

.comment-like {
  flex-direction: row;
  align-items: center;
}

.comment-like-icon {
  font-size: 18px;
  color: #999999;
}

.comment-like-count {
  font-size: 12px;
  color: #999999;
  margin-left: 4px;
}

.comment-like.liked .comment-like-icon {
  color: #ff4757;
}

.comment-text-wrap {
  margin-top: 4px;
}

.comment-text {
  font-size: 14px;
  color: #333333;
  line-height: 20px;
}

.comment-meta {
  flex-direction: row;
  align-items: center;
  margin-top: 4px;
}

.comment-time {
  font-size: 12px;
  color: #999999;
  margin-right: 16px;
}

.comment-reply {
  font-size: 13px;
  color: #666666;
}

/* å±•å¼€ X æ¡å›å¤ */
.comment-replies-toggle {
  margin-top: 4px;
}

.comment-replies-toggle-text {
  font-size: 12px;
  color: #666666;
}

.reply-list {
  margin-top: 6px;
}

.reply-item {
  flex-direction: row;
  padding-top: 6px;
  padding-bottom: 6px;
}

.reply-avatar {
  width: 28px;
  height: 28px;
  border-radius: 14px;
  margin-right: 8px;
}

.reply-main {
  flex: 1;
}

.reply-header {
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
}

.reply-name-line {
  flex-direction: row;
  align-items: center;
  flex-wrap: wrap;
}

.reply-username {
  font-size: 13px;
  font-weight: 500;
  color: #333333;
}

.reply-at {
  margin-left: 6px;
  font-size: 12px;
  color: #666666;
}

.reply-like {
  flex-direction: row;
  align-items: center;
}

.reply-like-icon {
  font-size: 16px;
  color: #999999;
}

.reply-like-count {
  font-size: 11px;
  color: #999999;
  margin-left: 4px;
}

.reply-like.liked .reply-like-icon {
  color: #ff4757;
}

.reply-text {
  font-size: 13px;
  color: #333333;
  line-height: 18px;
  margin-top: 2px;
}

.reply-meta {
  flex-direction: row;
  align-items: center;
  margin-top: 2px;
}

.reply-time {
  font-size: 11px;
  color: #999999;
  margin-right: 12px;
}

.reply-reply {
  font-size: 12px;
  color: #666666;
}

/* å±•å¼€æ›´å¤š / æ”¶èµ· åœ¨åŒä¸€è¡Œï¼Œæ•´ä½“ä½ç½®ä¸å›å¤åˆ—è¡¨å·¦è¾¹ä¸€è‡´ */
.reply-footer {
  flex-direction: row;
  align-items: center;
  margin-top: 2px;
  margin-bottom: 4px;
  font-size: 12px;
  color: #666666;
}

.reply-footer-loading {
  margin-left: 8px;
  font-size: 12px;
  color: #999999;
}

.reply-footer-collapse {
  margin-left: 12px;
  font-size: 12px;
  color: #666666;
}

/* ç©ºçŠ¶æ€ */
.empty-comments {
  padding-top: 32px;
  padding-bottom: 32px;
  justify-content: center;
  align-items: center;
}

.empty-comments-text {
  font-size: 14px;
  color: #999999;
}

/* è¯„è®ºè¾“å…¥æ¡ */
.comment-input-bar {
  height: 52px;
  padding-left: 12px;
  padding-right: 12px;
  border-top-width: 1px;
  border-top-style: solid;
  border-top-color: #f0f0f0;
  flex-direction: row;
  align-items: center;
}

.comment-input {
  flex: 1;
  height: 36px;
  background-color: #f5f5f5;
  border-radius: 18px;
  padding-left: 12px;
  padding-right: 12px;
  font-size: 14px;
}

.send-btn {
  margin-left: 8px;
  padding-left: 14px;
  padding-right: 14px;
  padding-top: 8px;
  padding-bottom: 8px;
  border-radius: 18px;
  background-color: #f0f0f0;
}

.send-btn-text {
  font-size: 14px;
  color: #999999;
}

.send-btn.active {
  background-color: #667eea;
}

.send-btn-text-active {
  color: #ffffff;
}
</style>
